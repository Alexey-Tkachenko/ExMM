# Архитектура бибиотеки

Базовым элементом библиотеки является шаблонный абстрактный класс контроллера устройства `ControllerBase`, от которого необходимо унаследовать свой тип, реализующий логику имитируемого аппаратного контроллера.
При создании объекта контроллера он регистрируется в специальном реестре, осуществляющем управление виртуальной памятью контроллера. Реестр в свою очередь при первом использовании регистрирует обработчик исключений/сигналов для обеспечения работы библиотеки.
После создания объект контроллера сам предоставляет указатель на область памяти, представляющей регистровый файл через метод публичный `GetIoArea()`. Размер области определяется размером структуры регистрового файла (передаётся шаблонным параметром в `RegisterBase` при наследовании), но всегда кратна странице в памяти. Эта эта область памяти выделяется и настраивается внутри библиотеки таким образом, чтобы была возможность выполнять перехваты (перехватываемые операции также передаются шаблонным параметром при наследовании от `ControllerBase`).
Контроллер может перекрыть три метода: 
- `Initialize`, который вызывается однократно для установки значений регистров в исходное значение;
- `HookWrite` для перехвата операции записи в регистровый файл;
- `HookRead` для перехвата чтения из регистрового файла.

Методы перехвата в момент своего вызова имеют неограниченный доступ к регистровому файлу через полученный аргументом указатель, и могут как считывать, так и изменять значения любых полей. Однако методы перехвата не должны делать предположений о том, каким образом они получают указатель на регистровый файл.

Для удобства использования память для представления регистрового файла проецируется в виртуальную память дважды: публичная область с ограниченным доступом (публичная память, доступная через метод `GetIoArea`) и приватная, доступная через защищённый метод `GetPrivateIoArea`, без ограничений доступа. Приватная область может потребоваться, например, для доступа в произвольное время к регистрам без генерации исключения/сигнала ошибки доступа к памяти.
